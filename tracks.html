<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Sailing Tracks</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700;900&display=swap" rel="stylesheet">
<!-- Leaflet for map display -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg: #060d14; --panel: #0a1820; --border: #1a3a50;
    --amber: #f0a500; --amber-dim: #7a5200;
    --cyan: #00d4ff; --cyan-dim: #004d5e;
    --red: #ff3c3c; --green: #4cff8f; --text-dim: #3a6070;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--amber);
    font-family: 'Roboto Mono', monospace;
    min-height: 100vh;
    padding: 12px;
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none;
  }

  .container { max-width: 480px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }

  .header-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 4px 0;
  }

  .header-row h1 { font-size: 0.75rem; letter-spacing: 0.3em; color: var(--cyan); text-transform: uppercase; }

  .back-link {
    font-size: 0.55rem; letter-spacing: 0.2em; color: var(--amber);
    text-decoration: none; text-transform: uppercase; opacity: 0.7;
  }
  .back-link:hover { opacity: 1; }

  /* ── SESSION LIST ── */
  .session-list { display: flex; flex-direction: column; gap: 8px; }

  .session-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: border-color 0.2s;
    position: relative;
    overflow: hidden;
  }

  .session-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    opacity: 0.4;
  }

  .session-card:hover, .session-card.active { border-color: var(--cyan); }

  .session-card-row { display: flex; justify-content: space-between; align-items: baseline; }
  .session-date { font-size: 0.8rem; font-weight: 700; color: var(--amber); }
  .session-pts  { font-size: 0.6rem; color: var(--text-dim); letter-spacing: 0.2em; }
  .session-time { font-size: 0.6rem; color: var(--text-dim); margin-top: 3px; }

  .empty-state { text-align: center; color: var(--text-dim); font-size: 0.7rem; letter-spacing: 0.2em; padding: 32px; }

  /* ── MAP ── */
  .map-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    display: none;
  }

  .map-panel.visible { display: block; }

  .map-header {
    padding: 10px 16px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .map-title { font-size: 0.6rem; letter-spacing: 0.3em; color: var(--cyan); text-transform: uppercase; }

  #map { height: 300px; width: 100%; }


  /* Stats row */
  .stats-row { display: flex; gap: 8px; padding: 0 16px 10px; }
  .stat-box { flex: 1; text-align: center; }
  .stat-val { font-size: 1rem; font-weight: 700; color: var(--amber); }
  .stat-lbl { font-size: 0.45rem; letter-spacing: 0.3em; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }

  .version-footer {
    text-align: center; font-size: 0.5rem;
    letter-spacing: 0.3em; color: var(--text-dim);
    padding: 6px 0 2px; opacity: 0.6;
  }

  .loading { text-align: center; color: var(--text-dim); font-size: 0.65rem; letter-spacing: 0.2em; padding: 20px; }

  /* ── SPEED CHART ── */
  .chart-panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    display: none;
    position: relative;
  }
  .chart-panel::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--amber), transparent);
    opacity: 0.5;
  }
  .chart-panel.visible { display: block; }
  .chart-header { padding: 10px 16px; border-bottom: 1px solid var(--border); }
  .chart-title { font-size: 0.6rem; letter-spacing: 0.3em; color: var(--amber); text-transform: uppercase; }
  .chart-wrap { padding: 12px; position: relative; height: 200px; }
</style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <h1>⚓ Track Log</h1>
    <a class="back-link" href="index.html">← INSTRUMENTS</a>
  </div>

  <div class="session-list" id="session-list">
    <div class="loading">LOADING TRACKS…</div>
  </div>

  <!-- Map panel (shown when a session is selected) -->
  <div class="map-panel" id="map-panel">
    <div class="map-header">
      <span class="map-title" id="map-title">TRACK</span>
    </div>
    <div id="map"></div>
    <div class="stats-row" id="stats-row"></div>
  </div>

  <!-- Speed/time chart -->
  <div class="chart-panel" id="chart-panel">
    <div class="chart-header">
      <span class="chart-title">SPEED OVER TIME</span>
    </div>
    <div class="chart-wrap">
      <canvas id="speed-chart"></canvas>
    </div>
  </div>

  <div class="version-footer">VERSION 0.3.6</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { Chart, registerables } from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/+esm";
  Chart.register(...registerables);

  const firebaseConfig = {
    apiKey: "AIzaSyCs3kFXZmQ59CUf9IkQ7UTPRcYi45hb9co",
    authDomain: "sailing-gps.firebaseapp.com",
    projectId: "sailing-gps",
    storageBucket: "sailing-gps.firebasestorage.app",
    messagingSenderId: "713152422055",
    appId: "1:713152422055:web:a45a4cfc77f7375b047b82",
    measurementId: "G-84LSZ2S9MG"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  let leafletMap     = null;
  let currentTrack   = null;   // array of point objects
  let currentSession = null;  // session metadata
  let speedChart     = null;
  let chartPts       = [];     // points array backing the current chart (1:1 with chart data indices)
  let highlightMarker = null;  // amber circle marker shown on map during chart hover

  // ── Load session list ──
  async function loadSessions() {
    const listEl = document.getElementById('session-list');
    try {
      const q    = query(collection(db, 'sessions'), orderBy('startedAt', 'desc'));
      const snap = await getDocs(q);

      if (snap.empty) {
        listEl.innerHTML = '<div class="empty-state">NO TRACKS SAVED YET</div>';
        return;
      }

      listEl.innerHTML = '';
      snap.forEach(docSnap => {
        const d     = docSnap.data();
        const start = d.startedAt?.toDate();
        const end   = d.endedAt?.toDate();
        const card  = document.createElement('div');
        card.className = 'session-card';
        card.innerHTML = `
          <div class="session-card-row">
            <span class="session-date">${start ? formatDate(start) : 'Unknown date'}</span>
            <span class="session-pts">${d.pointCount || '?'} PTS</span>
          </div>
          <div class="session-time">${start ? formatTime(start) : ''} ${end ? '→ ' + formatTime(end) : ''} ${duration(start, end)}</div>
        `;
        card.addEventListener('click', () => loadTrack(docSnap.id, start, card));
        listEl.appendChild(card);
      });
    } catch(e) {
      listEl.innerHTML = '<div class="empty-state">ERROR LOADING TRACKS</div>';
      console.error(e);
    }
  }

  // ── Load a session's points and draw map ──
  async function loadTrack(sessionId, startDate, cardEl) {
    // Highlight card
    document.querySelectorAll('.session-card').forEach(c => c.classList.remove('active'));
    cardEl.classList.add('active');

    const mapPanel = document.getElementById('map-panel');
    mapPanel.classList.add('visible');
    document.getElementById('map-title').textContent =
      startDate ? 'TRACK — ' + formatDate(startDate) : 'TRACK';

    try {
      const q    = query(collection(db, 'sessions', sessionId, 'points'), orderBy('ts', 'asc'));
      const snap = await getDocs(q);
      const pts  = [];
      snap.forEach(d => pts.push(d.data()));

      currentTrack   = pts;
      currentSession = { id: sessionId, startDate };

      drawMap(pts);
      drawStats(pts);
      drawSpeedChart(pts);
    } catch(e) {
      console.error(e);
    }
  }

  // ── Draw Leaflet map ──
  function drawMap(pts) {
    const coords = pts.filter(p => p.lat && p.lng).map(p => [p.lat, p.lng]);
    if (!coords.length) return;

    if (!leafletMap) {
      leafletMap = L.map('map', { zoomControl: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(leafletMap);
    } else {
      leafletMap.eachLayer(l => { if (!(l instanceof L.TileLayer)) leafletMap.removeLayer(l); });
    }
    highlightMarker = null;

    const polyline = L.polyline(coords, { color: '#00d4ff', weight: 3, opacity: 0.85 }).addTo(leafletMap);

    // Start marker (green) and end marker (red)
    L.circleMarker(coords[0], { radius: 7, color: '#4cff8f', fillColor: '#4cff8f', fillOpacity: 1 })
      .bindPopup('Start').addTo(leafletMap);
    L.circleMarker(coords[coords.length - 1], { radius: 7, color: '#ff3c3c', fillColor: '#ff3c3c', fillOpacity: 1 })
      .bindPopup('End').addTo(leafletMap);

    leafletMap.fitBounds(polyline.getBounds(), { padding: [20, 20] });
  }

  // ── Draw stats ──
  function drawStats(pts) {
    const validSpeeds = pts.filter(p => p.speed !== null && !isNaN(p.speed)).map(p => p.speed * 3.6);
    const maxSpeed    = validSpeeds.length ? Math.max(...validSpeeds).toFixed(1) : '--';
    const avgSpeed    = validSpeeds.length ? (validSpeeds.reduce((a,b)=>a+b,0)/validSpeeds.length).toFixed(1) : '--';
    const distKm      = calcDistance(pts).toFixed(2);

    document.getElementById('stats-row').innerHTML = `
      <div class="stat-box"><div class="stat-val">${distKm}</div><div class="stat-lbl">KM</div></div>
      <div class="stat-box"><div class="stat-val">${maxSpeed}</div><div class="stat-lbl">MAX KM/H</div></div>
      <div class="stat-box"><div class="stat-val">${avgSpeed}</div><div class="stat-lbl">AVG KM/H</div></div>
      <div class="stat-box"><div class="stat-val">${pts.length}</div><div class="stat-lbl">POINTS</div></div>
    `;
  }

  // ── Draw speed/time chart ──
  function drawSpeedChart(pts) {
    const chartPanel = document.getElementById('chart-panel');
    chartPanel.classList.add('visible');

    // Include all points — use 0 for null/missing speed values
    const validPts = pts.filter(p => p.ts);
    if (!validPts.length) {
      // Fallback: no timestamps, just use all points with index as x axis
      const allPts = pts;
      if (!allPts.length) return;
      chartPts = allPts;
      var labels  = allPts.map((_, i) => i % Math.max(1, Math.floor(allPts.length / 8)) === 0 ? String(i) : '');
      var speeds  = allPts.map(p => (p.speed != null && !isNaN(p.speed)) ? parseFloat((p.speed * 3.6).toFixed(1)) : 0);
    } else {
      chartPts = validPts;
      // Use elapsed time on x axis
      const startMs = validPts[0].ts.toDate ? validPts[0].ts.toDate().getTime()
                                             : validPts[0].ts.seconds * 1000;
      const rawLabels = validPts.map(p => {
        const ms   = p.ts.toDate ? p.ts.toDate().getTime() : p.ts.seconds * 1000;
        const mins = (ms - startMs) / 60000;
        return mins < 1 ? (mins * 60).toFixed(0) + 's' : mins.toFixed(1) + 'm';
      });
      var speeds = validPts.map(p =>
        (p.speed != null && !isNaN(p.speed)) ? parseFloat((p.speed * 3.6).toFixed(1)) : 0
      );
      // Thin labels — show at most 8
      const step = Math.max(1, Math.floor(rawLabels.length / 8));
      var labels = rawLabels.map((l, i) => i % step === 0 ? l : '');
    }

    const ctx = document.getElementById('speed-chart').getContext('2d');

    if (speedChart) {
      speedChart.destroy();
      speedChart = null;
    }

    speedChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Speed (km/h)',
          data: speeds,
          borderColor: '#f0a500',
          backgroundColor: 'rgba(240,165,0,0.08)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 400 },
        interaction: { mode: 'index', intersect: false },
        onHover(event, elements) {
          if (elements.length && leafletMap) {
            const idx = elements[0].index;
            const pt  = chartPts[idx];
            if (pt && pt.lat && pt.lng) {
              const latlng = [pt.lat, pt.lng];
              if (highlightMarker) {
                highlightMarker.setLatLng(latlng);
              } else {
                highlightMarker = L.circleMarker(latlng, {
                  radius: 8, color: '#f0a500', fillColor: '#f0a500', fillOpacity: 0.9, weight: 2
                }).addTo(leafletMap);
              }
            }
          } else if (highlightMarker) {
            leafletMap.removeLayer(highlightMarker);
            highlightMarker = null;
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#0a1820',
            borderColor: '#1a3a50',
            borderWidth: 1,
            titleColor: '#3a6070',
            bodyColor: '#f0a500',
            callbacks: {
              label: ctx => ctx.parsed.y.toFixed(1) + ' km/h'
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#3a6070', font: { family: 'Roboto Mono', size: 9 }, maxRotation: 0 },
            grid: { color: '#0d2535' }
          },
          y: {
            ticks: { color: '#3a6070', font: { family: 'Roboto Mono', size: 9 }, callback: v => v + ' km/h' },
            grid: { color: '#0d2535' },
            beginAtZero: true
          }
        }
      }
    });
  }

  // ── Calculate total distance (Haversine) ──
  function calcDistance(pts) {
    let total = 0;
    for (let i = 1; i < pts.length; i++) {
      const a = pts[i-1], b = pts[i];
      if (!a.lat || !b.lat) continue;
      total += haversine(a.lat, a.lng, b.lat, b.lng);
    }
    return total;
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371, dLat = rad(lat2-lat1), dLon = rad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(rad(lat1))*Math.cos(rad(lat2))*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  const rad = d => d * Math.PI / 180;

  // ── Formatting helpers ──
  function formatDate(d) {
    return d.toLocaleDateString('en-IE', { day:'2-digit', month:'short', year:'numeric' });
  }
  function formatTime(d) {
    return d.toLocaleTimeString('en-IE', { hour:'2-digit', minute:'2-digit' });
  }
  function duration(start, end) {
    if (!start || !end) return '';
    const mins = Math.round((end - start) / 60000);
    if (mins < 60) return `(${mins}m)`;
    return `(${Math.floor(mins/60)}h ${mins%60}m)`;
  }

  // Kick off
  loadSessions();
</script>
</body>
</html>
