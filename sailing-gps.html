<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Sailing Instruments</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060d14;
    --panel: #0a1820;
    --border: #1a3a50;
    --amber: #f0a500;
    --amber-dim: #7a5200;
    --cyan: #00d4ff;
    --cyan-dim: #004d5e;
    --red: #ff3c3c;
    --green: #4cff8f;
    --text-dim: #3a6070;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--amber);
    font-family: 'Roboto Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    padding: 12px 12px 8px;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }

  .container {
    width: 100%;
    max-width: 480px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
  }

  .header {
    text-align: center;
    letter-spacing: 0.3em;
    font-size: 0.6rem;
    color: var(--cyan);
    text-transform: uppercase;
    opacity: 0.6;
    padding: 2px 0;
  }

  /* ‚îÄ‚îÄ BIG BEARING ‚îÄ‚îÄ */
  .bearing-hero {
    width: 100%;
    text-align: center;
    line-height: 0.95;
    padding: 4px 0;
  }

  .bearing-hero-value {
    font-size: min(48vw, calc(100vw - 24px));
    font-weight: 900;
    color: #ffffff;
    letter-spacing: -0.04em;
    text-shadow: 0 0 60px rgba(255,255,255,0.25);
    font-variant-numeric: tabular-nums;
    display: block;
    width: 100%;
  }

  /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    position: relative;
    overflow: hidden;
  }

  .panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--amber), transparent);
    opacity: 0.5;
  }

  .panel.cyan-accent::before {
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  }

  .panel.green-accent::before {
    background: linear-gradient(90deg, transparent, var(--green), transparent);
  }

  .label {
    font-size: 0.5rem;
    letter-spacing: 0.4em;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 8px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ COMPASS ‚îÄ‚îÄ */
  .compass-row {
    display: flex;
    align-items: stretch;
    gap: 10px;
  }

  .compass-dial-box {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .compass-dial { width: 140px; height: 140px; flex-shrink: 0; }
  .compass-dial svg { width: 100%; height: 100%; }

  .compass-cardinal-box {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cardinal-display {
    font-size: 3rem;
    font-weight: 900;
    color: var(--cyan);
    letter-spacing: 0.1em;
    text-shadow: 0 0 20px rgba(0,212,255,0.45);
    line-height: 1;
    text-align: center;
  }

  .compass-sub-label {
    font-size: 0.5rem;
    letter-spacing: 0.35em;
    color: var(--text-dim);
    text-transform: uppercase;
  }

  #needle {
    transform-origin: 50% 50%;
    transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  /* ‚îÄ‚îÄ SPEED ‚îÄ‚îÄ */
  .speed-panel { text-align: center; }

  .speed-value {
    font-size: clamp(4rem, 29vw, 11rem);
    font-weight: 900;
    line-height: 1;
    color: var(--cyan);
    letter-spacing: -0.02em;
    text-shadow: 0 0 40px rgba(0,212,255,0.45);
    font-variant-numeric: tabular-nums;
    display: block;
  }

  .speed-unit { font-size: 0.65rem; color: var(--cyan-dim); letter-spacing: 0.4em; margin-top: 4px; }

  /* ‚îÄ‚îÄ RECORDING PANEL ‚îÄ‚îÄ */
  .record-panel {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .record-btn {
    flex-shrink: 0;
    background: transparent;
    border: 1px solid var(--green);
    color: var(--green);
    font-family: 'Roboto Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    padding: 10px 16px;
    cursor: pointer;
    border-radius: 4px;
    text-transform: uppercase;
    transition: background 0.2s, color 0.2s;
  }

  .record-btn:hover, .record-btn:active { background: var(--green); color: var(--bg); }

  .record-btn.recording {
    border-color: var(--red);
    color: var(--red);
  }
  .record-btn.recording:hover, .record-btn.recording:active {
    background: var(--red);
    color: var(--bg);
  }

  .record-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .record-status {
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    color: var(--text-dim);
  }

  .record-status.active { color: var(--green); }

  .record-points {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--amber);
    font-variant-numeric: tabular-nums;
  }

  .tracks-link {
    font-size: 0.55rem;
    letter-spacing: 0.2em;
    color: var(--cyan);
    text-decoration: none;
    text-transform: uppercase;
    opacity: 0.7;
    align-self: flex-end;
  }
  .tracks-link:hover { opacity: 1; }

  /* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
  .status-row { display: flex; gap: 10px; }

  .status-item {
    flex: 1;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    text-align: center;
  }

  .status-val { font-size: 1rem; font-weight: 700; color: #aaa; }
  .status-val.good { color: var(--green); }
  .status-val.warn { color: var(--amber); }
  .status-val.bad  { color: var(--red); }

  /* ‚îÄ‚îÄ VERSION ‚îÄ‚îÄ */
  .version-footer {
    text-align: center;
    font-size: 0.55rem;
    letter-spacing: 0.3em;
    color: #6a9ab0;
    padding: 6px 0 2px;
  }

  /* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(6,13,20,0.96);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center; padding: 32px;
    z-index: 100; gap: 18px;
  }

  .overlay p  { font-size: 0.75rem; color: var(--text-dim); line-height: 1.6; max-width: 300px; }
  .overlay-version { font-size: 0.55rem; letter-spacing: 0.3em; color: #6a9ab0; }

  .btn {
    background: transparent;
    border: 1px solid var(--amber);
    color: var(--amber);
    font-family: 'Roboto Mono', monospace;
    font-size: 0.7rem; letter-spacing: 0.3em;
    padding: 12px 28px; cursor: pointer;
    border-radius: 4px; text-transform: uppercase;
    transition: background 0.2s, color 0.2s;
  }
  .btn:hover, .btn:active { background: var(--amber); color: var(--bg); }

  .blink { animation: blink 1s step-end infinite; }
  @keyframes blink { 50% { opacity: 0; } }
  .hidden { display: none; }

  .divider { width: 100%; height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); }

  /* ‚îÄ‚îÄ Splash animations ‚îÄ‚îÄ */
  @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes pulse-glow {
    0%, 100% { text-shadow: 0 0 8px rgba(0,212,255,0.15); }
    50%      { text-shadow: 0 0 24px rgba(0,212,255,0.5), 0 0 48px rgba(0,212,255,0.2); }
  }
  @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

  .overlay .compass-icon {
    display: inline-block;
    width: 60px; height: 60px;
    animation: spin-slow 12s linear infinite, fade-in 1s ease-out;
    vertical-align: middle;
    margin-bottom: 8px;
  }

  .overlay h2 { font-size: 1.1rem; letter-spacing: 0.2em; color: var(--cyan); animation: pulse-glow 3.5s ease-in-out infinite; }

  .overlay-tagline {
    font-size: 0.55rem;
    letter-spacing: 0.35em;
    color: var(--text-dim);
    text-transform: uppercase;
  }

  .overlay-features {
    font-size: 0.7rem;
    color: var(--text-dim);
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .overlay-tracks-link {
    font-size: 0.55rem;
    letter-spacing: 0.2em;
    color: var(--cyan);
    text-decoration: none;
    text-transform: uppercase;
    opacity: 0.6;
    transition: opacity 0.2s;
  }
  .overlay-tracks-link:hover { opacity: 1; }
</style>
</head>
<body>

<!-- Launch overlay -->
<div class="overlay" id="overlay">
  <svg class="compass-icon" viewBox="0 0 60 60" fill="none">
    <circle cx="30" cy="30" r="28" stroke="#1a3a50" stroke-width="1.2"/>
    <circle cx="30" cy="30" r="24" stroke="#0d2535" stroke-width="4"/>
    <polygon points="30,6 27,30 30,34 33,30"  fill="#f0a500" opacity="0.9"/>
    <polygon points="30,54 27,30 30,34 33,30"  fill="#2a4a5a"/>
    <circle cx="30" cy="30" r="2.5" fill="#0a1820" stroke="#f0a500" stroke-width="1"/>
    <text x="30" y="9"  text-anchor="middle" fill="#f0a500" font-family="Roboto Mono,monospace" font-size="5" font-weight="700">N</text>
    <text x="54" y="32" text-anchor="middle" fill="#3a6070" font-family="Roboto Mono,monospace" font-size="4">E</text>
    <text x="30" y="58" text-anchor="middle" fill="#3a6070" font-family="Roboto Mono,monospace" font-size="4">S</text>
    <text x="6"  y="32" text-anchor="middle" fill="#3a6070" font-family="Roboto Mono,monospace" font-size="4">W</text>
  </svg>
  <h2>SAILING GPS</h2>
  <div class="overlay-tagline">HEADING ¬∑ SPEED ¬∑ TRACK</div>
  <div class="overlay-features">
    <div>üì° GPS for live heading & speed</div>
    <div>‚òÅÔ∏è Track recording saved to cloud</div>
  </div>
  <button class="btn" id="enable-btn" onclick="startGPS()">ENABLE GPS</button>
  <p id="err-msg" style="color:#ff3c3c;"></p>
  <a class="overlay-tracks-link" href="tracks.html">or VIEW SAVED TRACKS ‚Üí</a>
  <div class="overlay-version">VERSION 0.4.3</div>
</div>

<!-- Silent audio for iOS screen-awake workaround -->
<audio id="silent-audio" loop>
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAA
EAAQARAAoAAABYAQACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<div class="container">
  <!-- Full-width bearing -->
  <div class="bearing-hero">
    <span class="bearing-hero-value" id="bearing">---</span>
  </div>

  <div class="divider"></div>

  <!-- Compass + cardinal -->
  <div class="panel">
    <div class="compass-row">
      <div class="compass-dial-box">
        <div class="compass-dial">
          <svg viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="56" fill="none" stroke="#1a3a50" stroke-width="1.5"/>
            <circle cx="60" cy="60" r="52" fill="none" stroke="#0d2535" stroke-width="8"/>
            <text x="60" y="13"  text-anchor="middle" fill="#f0a500" font-family="Roboto Mono,monospace" font-size="9" font-weight="700">N</text>
            <text x="107" y="64" text-anchor="middle" fill="#3a6070" font-family="Roboto Mono,monospace" font-size="7">E</text>
            <text x="60" y="112" text-anchor="middle" fill="#3a6070" font-family="Roboto Mono,monospace" font-size="7">S</text>
            <text x="13" y="64"  text-anchor="middle" fill="#3a6070" font-family="Roboto Mono,monospace" font-size="7">W</text>
            <g id="needle">
              <polygon points="60,16 56,60 60,68 64,60" fill="#f0a500" opacity="0.9"/>
              <polygon points="60,104 56,60 60,68 64,60" fill="#2a4a5a"/>
            </g>
            <circle cx="60" cy="60" r="4" fill="#0a1820" stroke="#f0a500" stroke-width="1.5"/>
          </svg>
        </div>
      </div>
      <div class="compass-cardinal-box">
        <div class="cardinal-display" id="cardinal">--</div>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Speed -->
  <div class="panel cyan-accent speed-panel">
    <span class="speed-value" id="speed">--.-</span>
    <div class="speed-unit">KM / HR</div>
  </div>

  <div class="divider"></div>

  <!-- Track recording -->
  <div class="panel green-accent">
    <div class="record-panel">
      <button class="record-btn" id="record-btn" onclick="toggleRecording()">‚è∫ START</button>
      <div class="record-info">
        <div class="record-status" id="record-status">NOT RECORDING</div>
        <div class="record-points"><span id="point-count">0</span> PTS</div>
      </div>
      <a class="tracks-link" href="tracks.html">VIEW TRACKS ‚Üí</a>
    </div>
  </div>

  <!-- Status -->
  <div class="status-row">
    <div class="status-item">
      <div class="label">ACCURACY</div>
      <div class="status-val" id="accuracy">-- m</div>
    </div>
    <div class="status-item">
      <div class="label">GPS</div>
      <div class="status-val blink" id="gps-status">WAIT</div>
    </div>
    <div class="status-item">
      <div class="label">MOTION</div>
      <div class="status-val" id="motion-status">--</div>
    </div>
    <div class="status-item">
      <div class="label">CLOUD</div>
      <div class="status-val" id="db-status">--</div>
    </div>
  </div>

  <div class="version-footer">VERSION 0.4.3</div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCs3kFXZmQ59CUf9IkQ7UTPRcYi45hb9co",
    authDomain: "sailing-gps.firebaseapp.com",
    projectId: "sailing-gps",
    storageBucket: "sailing-gps.firebasestorage.app",
    messagingSenderId: "713152422055",
    appId: "1:713152422055:web:a45a4cfc77f7375b047b82",
    measurementId: "G-84LSZ2S9MG"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ‚îÄ‚îÄ GPS state ‚îÄ‚îÄ
  let watchId     = null;
  let lastBearing = 0;
  let lastPos     = null;

  // ‚îÄ‚îÄ Recording state ‚îÄ‚îÄ
  let recording    = false;
  let sessionRef   = null;
  let sessionId    = null;
  let pointCount   = 0;

  // ‚îÄ‚îÄ Expose toggle to global scope ‚îÄ‚îÄ
  window.toggleRecording = async function() {
    if (!recording) {
      // Start a new session document
      try {
        sessionRef = doc(collection(db, 'sessions'));
        sessionId  = sessionRef.id;
        await setDoc(sessionRef, {
          startedAt: serverTimestamp(),
          pointCount: 0
        });
        recording   = true;
        pointCount  = 0;
        document.getElementById('point-count').textContent = '0';
        document.getElementById('record-btn').textContent  = '‚èπ STOP';
        document.getElementById('record-btn').classList.add('recording');
        const rs = document.getElementById('record-status');
        rs.textContent = 'RECORDING';
        rs.classList.add('active');
        setDbStatus('OK', 'good');
      } catch(e) {
        setDbStatus('ERR', 'bad');
        console.error(e);
      }
    } else {
      // Stop recording ‚Äî update session with end time and point count
      recording = false;
      try {
        await setDoc(sessionRef, { endedAt: serverTimestamp(), pointCount }, { merge: true });
      } catch(e) { console.error(e); }
      document.getElementById('record-btn').textContent = '‚è∫ START';
      document.getElementById('record-btn').classList.remove('recording');
      const rs = document.getElementById('record-status');
      rs.textContent = 'STOPPED';
      rs.classList.remove('active');
      setDbStatus('SAVED', 'good');
      sessionRef = null;
    }
  };

  async function savePoint(pos) {
    if (!recording || !sessionRef) return;
    try {
      await addDoc(collection(db, 'sessions', sessionId, 'points'), {
        lat:      pos.coords.latitude,
        lng:      pos.coords.longitude,
        heading:  pos.coords.heading,
        speed:    pos.coords.speed,
        accuracy: pos.coords.accuracy,
        ts:       serverTimestamp()
      });
      pointCount++;
      document.getElementById('point-count').textContent = pointCount;
    } catch(e) {
      setDbStatus('ERR', 'bad');
      console.error(e);
    }
  }

  function setDbStatus(text, cls) {
    const el = document.getElementById('db-status');
    el.textContent  = text;
    el.className    = 'status-val ' + cls;
  }

  // ‚îÄ‚îÄ Compass helpers ‚îÄ‚îÄ
  function toCardinal(deg) {
    const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
    return dirs[Math.round(deg / 22.5) % 16];
  }

  function rotateTo(deg) {
    let diff = deg - lastBearing;
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;
    lastBearing += diff;
    document.getElementById('needle').style.transform = `rotate(${lastBearing}deg)`;
  }



  // ‚îÄ‚îÄ GPS callbacks ‚îÄ‚îÄ
  function onPosition(pos) {
    document.getElementById('overlay').classList.add('hidden');
    lastPos = pos;
    const { heading, speed, accuracy: acc } = pos.coords;

    if (heading !== null && !isNaN(heading)) {
      const deg = Math.round(heading);
      document.getElementById('bearing').textContent  = String(deg).padStart(3,'0');
      document.getElementById('cardinal').textContent = toCardinal(deg);
      rotateTo(heading);
    } else {
      document.getElementById('bearing').textContent  = '---';
      document.getElementById('cardinal').textContent = '--';
    }

    document.getElementById('speed').textContent =
      (speed !== null && !isNaN(speed)) ? (speed * 3.6).toFixed(1) : '--.-';

    if (acc !== null) {
      document.getElementById('accuracy').textContent = acc.toFixed(0) + ' m';
      document.getElementById('accuracy').className =
        'status-val ' + (acc < 10 ? 'good' : acc < 30 ? 'warn' : 'bad');
    }

    const s = document.getElementById('gps-status');
    s.textContent = 'LIVE'; s.className = 'status-val good'; s.style.animation = 'none';

    savePoint(pos);
  }

  function onError(err) {
    document.getElementById('err-msg').textContent = err.message;
    const s = document.getElementById('gps-status');
    s.textContent = 'ERR'; s.className = 'status-val bad blink';
    // Restore button
    const btn = document.getElementById('enable-btn');
    btn.textContent = 'ENABLE GPS';
    btn.classList.remove('blink');
    btn.disabled = false;
  }

  // ‚îÄ‚îÄ Screen-awake: Wake Lock API (Android/Chrome) + silent audio (iOS Safari) ‚îÄ‚îÄ
  let wakeLock = null;

  async function requestWakeLock() {
    if ('wakeLock' in navigator) {
      // Chrome / Android
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          if (!document.hidden) requestWakeLock();
        });
      } catch(e) {
        console.warn('Wake lock not granted:', e);
      }
    } else {
      // iOS Safari fallback ‚Äî play silent audio to prevent screen sleep
      const audio = document.getElementById('silent-audio');
      if (audio) {
        audio.play().catch(() => {});
      }
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) requestWakeLock();
  });

  // ‚îÄ‚îÄ iOS: request motion/orientation permission for heading ‚îÄ‚îÄ
  async function requestiOSMotion() {
    const motionEl = document.getElementById('motion-status');
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      // iOS ‚Äî permission required
      try {
        const result = await DeviceOrientationEvent.requestPermission();
        if (result === 'granted') {
          motionEl.textContent = 'OK';
          motionEl.className   = 'status-val good';
        } else {
          motionEl.textContent = 'DENIED';
          motionEl.className   = 'status-val bad';
          document.getElementById('err-msg').textContent =
            'Motion permission denied ‚Äî heading may not work.';
        }
      } catch(e) {
        motionEl.textContent = 'ERR';
        motionEl.className   = 'status-val bad';
        console.warn('Motion permission error:', e);
      }
    } else {
      // Android / non-iOS ‚Äî motion permission not required
      motionEl.textContent = 'OK';
      motionEl.className   = 'status-val good';
    }
  }

  window.startGPS = async function() {
    const btn = document.getElementById('enable-btn');
    if (!navigator.geolocation) {
      document.getElementById('err-msg').textContent = 'Geolocation not supported.';
      return;
    }
    // Button loading state
    btn.textContent = 'ACQUIRING‚Ä¶';
    btn.classList.add('blink');
    btn.disabled = true;
    // Request iOS motion permission first (must be triggered by user gesture)
    await requestiOSMotion();
    requestWakeLock();
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(onPosition, onError, {
      enableHighAccuracy: true, maximumAge: 0, timeout: 10000
    });
  };

  // ‚îÄ‚îÄ Draw compass tick marks ‚îÄ‚îÄ
  (function() {
    const svg = document.querySelector('svg');
    const g   = document.createElementNS('http://www.w3.org/2000/svg','g');
    for (let i = 0; i < 72; i++) {
      const rad     = (i * 5 - 90) * Math.PI / 180;
      const isMajor = i % 9 === 0, isMed = i % 3 === 0;
      const r1 = 52, r2 = isMajor ? 42 : isMed ? 45 : 48;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', 60 + r1 * Math.cos(rad));
      line.setAttribute('y1', 60 + r1 * Math.sin(rad));
      line.setAttribute('x2', 60 + r2 * Math.cos(rad));
      line.setAttribute('y2', 60 + r2 * Math.sin(rad));
      line.setAttribute('stroke', isMajor ? '#f0a500' : '#2a4a5a');
      line.setAttribute('stroke-width', isMajor ? '1.5' : '0.8');
      g.appendChild(line);
    }
    svg.insertBefore(g, document.getElementById('needle'));
  })();

</script>
</body>
</html>
